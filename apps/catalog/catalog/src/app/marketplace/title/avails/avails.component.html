<section fxLayout fxLayout="space-between center" fxLayoutGap="24px">

  <aside>
    <mat-card>
      <mat-card-header>
        <mat-card-title>Avail Search Criteria</mat-card-title>
      </mat-card-header>
      <mat-divider></mat-divider>
      <mat-card-header>
        <mat-card-subtitle>
          <span>Fill in the following fields to know where, when and in which conditions this title is available</span>
          <span>
            Search results use an "and" logic for multiple conditions, not an "or" logic.
            <mat-icon matTooltip="If you check TV and VOD media, you will get territories where both media are available (not either of them)" svgIcon="info"></mat-icon>
          </span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="form">
          <static-group formControlName="medias" scope="medias" displayAll="All Rights" required placeholder="Specify right(s) to filter" [withoutValues]="['theatrical']" test-id="medias" icon="play_arrow">
            <mat-label>Media</mat-label>
          </static-group>

          <mat-form-field appearance="outline">
            <mat-label>Exlusivity</mat-label>
            <mat-select formControlName="exclusive">
              <mat-option [value]="true">Exclusive</mat-option>
              <mat-option [value]="false">Non exclusive</mat-option>
            </mat-select>
            <mat-icon matPrefix svgIcon="star"></mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" formGroupName="duration">
            <mat-label>Start Date</mat-label>
            <input matInput [matDatepicker]="datepickerFrom" formControlName="from">
            <mat-datepicker-toggle matPrefix [for]="datepickerFrom" test-id="dateFrom"></mat-datepicker-toggle>
            <mat-datepicker #datepickerFrom> </mat-datepicker>
            <mat-error *ngIf="form.hasError('startOverEnd', 'duration.from')">Start date must not be later than end date</mat-error>
            <mat-error *ngIf="form.hasError('inPast', 'duration.from')">Date must be in the future</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" formGroupName="duration">
            <mat-label>End Date</mat-label>
            <input matInput [matDatepicker]="datepickerTo" formControlName="to">
            <mat-datepicker-toggle matPrefix [for]="datepickerTo" test-id="dateTo"></mat-datepicker-toggle>
            <mat-datepicker #datepickerTo> </mat-datepicker>
            <mat-error *ngIf="form.hasError('startOverEnd', 'duration.to')">End date must not be earlier than start date</mat-error>
            <mat-error *ngIf="form.hasError('inPast', 'duration.from')">Date must be in the future</mat-error>
          </mat-form-field>
        </form>
        <article fxLayout fxLayoutAlign="space-between">
          <button mat-stroked-button (click)="form.reset()">Clear</button>
          <button mat-flat-button color="primary" (click)="applyFilters()">Apply Filters</button>
        </article>
      </mat-card-content>
    </mat-card>
  </aside>

  <mat-card class="map-card">
    <mat-card-header>
      <mat-card-title>Available territories</mat-card-title>
      <mat-card-subtitle *ngIf="org$ | async as org">
        Click on the territories you're interested in to add them to your Selection. For territories that are not licensed, feel free to
        <a [routerLink]="['/c/o/marketplace/organization', org.id, 'member']">contact {{ org | orgName }}</a>.
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <world-map>

        <!-- MAP LAYERS -->
        <ng-container *ngFor="let tag of notLicensedTerritories; trackBy: trackByTag">
          <map-feature [tag]="tag.isoA3" color="color-3"
            (mouseover)="dislpayTerritoryTooltip(tag.label, 'Not licensed')" (mouseout)="clearTerritoryTooltip()">
          </map-feature>
        </ng-container>
        <ng-container *ngFor="let tag of rightsSoldTerritories; trackBy: trackByTag">
          <map-feature [tag]="tag.isoA3" color="color-2"
            (mouseover)="dislpayTerritoryTooltip(tag.label, 'Rights sold')" (mouseout)="clearTerritoryTooltip()">
          </map-feature>
        </ng-container>
        <ng-container *ngFor="let tag of availableTerritories; trackBy: trackByTag">
          <map-feature [tag]="tag.isoA3" color="color-1" (click)="select($event)"
            (mouseover)="dislpayTerritoryTooltip(tag.label, 'Available')" (mouseout)="clearTerritoryTooltip()">
          </map-feature>
        </ng-container>
        <ng-container *ngFor="let tag of territoriesIsoA3">
          <map-feature [tag]="tag" color="color-4"></map-feature>
        </ng-container>

        <!-- TOOLTIP ON HOVERING-->
        <mat-card *ngIf="hoveredTerritory" class="hovered-territory-card">
          <ul>
            <li> {{ hoveredTerritory.name }} </li>
            <li class="mat-caption"> {{ hoveredTerritory.status }} </li>
          </ul>
        </mat-card>

        <!-- MAP LEGEND -->
        <mat-card class="colors-card">
          <mat-list>
            <mat-list-item>
              <svg viewBox="0 0 100 100" width="10px" height="10px">
                <rect fill="var(--color-1)" x="0" y="0" width="100" height="100" />
              </svg>
              <span class="mat-caption">Available</span>
            </mat-list-item>
            <mat-list-item>
              <svg viewBox="0 0 100 100" width="10px" height="10px">
                <rect fill="var(--color-2)" x="0" y="0" width="100" height="100" />
              </svg>
              <span class="mat-caption">Rights Sold</span>
            </mat-list-item>
            <mat-list-item>
              <svg viewBox="0 0 100 100" width="10px" height="10px">
                <rect fill="var(--color-3)" x="0" y="0" width="100" height="100" />
              </svg>
              <span class="mat-caption">
                Not Licensed
                <mat-icon matTooltip="You can contact the seller directly for more information." svgIcon="info"></mat-icon>
              </span>
            </mat-list-item>
          </mat-list>
        </mat-card>
      </world-map>
    </mat-card-content>

  </mat-card>
</section>

<ng-container *ngIf="bucket$ | async as bucket">
  <h2>Preselected Rights</h2>
  <ng-container *ngFor="let contract of bucket.contracts">
    <mat-card *ngFor="let term of contract.terms">
      <form [formGroup]="bucketForm">
        <mat-card-header>
          <mat-card-title>Exclusive rights from {{ term.duration.from | date: 'MM/dd/yyyy' }} until {{ term.duration.to | date: 'MM/dd/yyyy' }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-accordion>
            <!-- TERRITORIES -->
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  Territories
                </mat-panel-title>
              </mat-expansion-panel-header>
              <article class="expansion-panel-content">
                <mat-chip-list aria-label="Territories">
                  <mat-chip *ngFor="let territory of term.territories">{{ territory | toLabel: 'territories' }}</mat-chip>
                </mat-chip-list>
              </article>

            </mat-expansion-panel>

            <!-- MEDIAS -->
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  Medias
                </mat-panel-title>
              </mat-expansion-panel-header>
              <article class="expansion-panel-content">
                <mat-chip-list aria-label="Medias">
                  <mat-chip *ngFor="let media of term.medias">{{ media | toLabel: 'medias' }}</mat-chip>
                </mat-chip-list>
              </article>
            </mat-expansion-panel>

            <!-- VERSIONS -->
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  Versions
                  <span class="mat-body-2">&nbsp;(Non Mandatory)</span>
                </mat-panel-title>
              </mat-expansion-panel-header>
              <article class="expansion-panel-content">
                <strong>Original Languages</strong>
                <p>{{ movie.originalLanguages | toLabel: 'languages' }}</p>
                <strong>Request Specific Versions</strong>

                <!-- FORM -->
                <article formGroupName="languages" fxLayout="column" fxLayoutGap="24px">
                  <ng-container *ngFor="let language of bucketForm.controls.languages.controls | keyvalue">
                    <div fxLayout="column" fxLayoutGap="8px">
                      <p class="uppercase">{{ language.key | toLabel: 'languages' }}</p>
                      <div [formGroupName]="language.key" fxLayout fxLayoutAlign="start center" fxLayoutGap="16px">
                        <mat-checkbox formControlName="subtitle" color="primary">Subtitles</mat-checkbox>
                        <mat-checkbox formControlName="dubbed" color="primary">Dubbings</mat-checkbox>
                        <mat-checkbox formControlName="caption" color="primary">Closed Captions</mat-checkbox>
                        <button mat-icon-button (click)="deleteLanguage(language.key)" color="warn">
                          <mat-icon svgIcon="delete"></mat-icon>
                        </button>
                      </div>
                      <ng-container *ngIf="language.value.hasError('noVersion')">
                        <p class="mat-error" *ngIf="language.value.touched">Please select a version above or delete this language.</p>
                        <p class="mat-caption" *ngIf="language.value.untouched">Please select the applicable version(s).</p>
                      </ng-container>
                    </div>
                  </ng-container>
                </article>

                <!-- ADD LANGUAGE -->
                <div fxLayout fxLayoutAlign="start baseline" fxLayoutGap="16px" *ngIf="showButtons else noButtons">
                  <mat-divider inset></mat-divider>
                  <span class="mat-caption text-primary">Add a Version</span>
                  <button mat-mini-fab color="primary" (click)="this.showButtons = !this.showButtons">
                    <mat-icon svgIcon="add"></mat-icon>
                  </button>
                </div>
                <ng-template #noButtons>
                  <input-autocomplete test-id="languages" scope="languages" [control]="languageCtrl" withoutValues="['all']">
                    <mat-label>Languages</mat-label>
                  </input-autocomplete>
                  <div fxLayout fxLayoutAlign="space-between start">
                    <button mat-stroked-button [disabled]="languageCtrl.invalid" (click)="addLanguage()"
                      [disabled]="!languageCtrl.value">
                      <mat-icon svgIcon="save"></mat-icon>
                      <span>Save Language</span>
                    </button>
                  </div>
                </ng-template>
              </article>
            </mat-expansion-panel>

            <!-- RUNS -->
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  Runs
                  <span class="mat-body-2">&nbsp;(Non Mandatory)</span>
                </mat-panel-title>
              </mat-expansion-panel-header>
              <article class="expansion-panel-content" fxLayout="column" fxFlex formGroupName="runs">
                <p>Broadcasts</p>
                <mat-form-field appearance="outline">
                  <mat-label>Number of Broadcasts</mat-label>
                  <input matInput type="number" placeholder="Number of Broadcasts" formControlName="broadcasts">
                </mat-form-field>
                <p>Catch Up Rights</p>
                <div fxFlex fxLayout fxLayoutGap="16px" fxLayoutAlign="start space-between" formGroupName="catchup">
                  <mat-form-field appearance="outline" fxFlex>
                    <mat-label>Start Date</mat-label>
                    <input matInput [matDatepicker]="datePicker" placeholder="MM/DD/YYYY" formControlName="from">
                    <mat-datepicker-toggle matPrefix [for]="datePicker">
                      <mat-icon matDatepickerToggleIcon svgIcon="calendar_today"></mat-icon>
                    </mat-datepicker-toggle>
                    <mat-datepicker #datePicker></mat-datepicker>
                  </mat-form-field>
                  <mat-form-field appearance="outline" fxFlex>
                    <mat-label>Duration</mat-label>
                    <input matInput type="number" placeholder="Duration" formControlName="duration">
                  </mat-form-field>
                  <mat-form-field appearance="outline" fxFlex>
                    <mat-label>Period</mat-label>
                    <mat-select matInput placeholder="Period" formControlName="period">
                      <mat-option *ngFor="let period of periods" [value]="period">
                        {{ period | titlecase }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </article>
            </mat-expansion-panel>
          </mat-accordion>
        </mat-card-content>
      </form>
    </mat-card>
  </ng-container>
  <button mat-flat-button color="primary" class="mat-body-2" (click)="addToSelection()">
    <span>Add to Selection</span>
    <mat-icon svgIcon="arrow_forward"></mat-icon>
  </button>
</ng-container>
