<!-- In case bucket doesn't exist yet, empty is shown -->
<ng-container *ngIf="bucket$ | async as bucket; else empty">
  <ng-container *ngIf="!!bucket.contracts.length else empty">
    <header class="dark-contrast-theme main-header" bgAsset="banner_header_page.webp">
      <div class="main-title" fxLayout="column" fxLayoutAlign="center center">
        <h1>My Selection</h1>
        <p>There are {{ bucket.contracts.length }} titles in my selection</p>
        <p>Total price: {{ bucket | bucketTotalPrice | currency:bucket.currency }}</p>
      </div>
      <div fxLayout="column" fxLayoutAlign="center center">
        <p *ngIf="bucket | bucketTitles | getTitle | async as titles">
          {{ (titles | deepKey:'title.international').join(', ') }}
        </p>
        <button mat-flat-button color="primary" (click)="createOffer(bucket)">Create Offer</button>
      </div>
    </header>

    <section>
      <h2>Please choose currency</h2>
      <mat-form-field appearance="outline">
        <mat-label>Select</mat-label>
        <mat-select [value]="bucket.currency" (selectionChange)="updateCurrency($event.value)" test-id="selection-currency">
          <ng-container *ngFor="let currency of currencies | keyvalue">
            <mat-option [value]="currency.key">{{ currency.value }}</mat-option>
          </ng-container>
        </mat-select>
      </mat-form-field>
    </section>

    <ng-container *ngFor="let contract of bucket.contracts; trackBy: trackById; let i = index">
      <section class="contract surface" test-id="avails-section">
        <header fxLayout fxLayoutAlign="space-between start">
          <ng-container *ngIf="contract.titleId | getTitle | async as title">
            <section fxLayout="column">
              <h2>{{ title.title.international }}</h2>
              <article fxLayout fxLayoutGap="12px">
                <img [ref]="title.poster | storageFile: 'movies':'poster':title.id" asset="empty_poster.webp"
                  alt="Movie Illustration" [delay]="0">
                <div fxLayout="column">
                  <h3>{{ title.directors | displayName }}</h3>
                  <p>{{ title | movieFeature}}</p>
                </div>
              </article>
            </section>
            <mat-form-field appearance="outline">
              <mat-label>Price</mat-label>
              <input matInput type="number" min="0" [value]="contract.price" (input)="debouncedUpdatePriceControl(i, $event.target.value)" [attr.test-id]="'price-' + i"/>
              <mat-icon matPrefix [svgIcon]="bucket.currency"></mat-icon>
            </mat-form-field>
          </ng-container>
        </header>
        <bf-table-filter [source]="contract.terms" [columns]="columns" [initialColumns]="initialColumns" showFilter>
          <ng-template colRef="duration" let-duration>
            {{ duration.from | date }} - {{ duration.to | date }}
          </ng-template>
          <ng-template colRef="territories" let-territories>
            <section (click)="openDetails(territories, 'territories')">
              {{ territories | toLabel:'territories':3 }}
            </section>
          </ng-template>
          <ng-template colRef="medias" let-medias>
            {{ medias | toLabel:'medias' }}
          </ng-template>
          <ng-template colRef="exclusive" let-exclusive>
            {{ exclusive ? 'Yes' : 'No' }}
          </ng-template>
          <ng-template colAction="action" label="Actions" let-termIndex="index">
            <button mat-icon-button (click)="removeTerm(i, termIndex)">
              <mat-icon svgIcon="delete"></mat-icon>
            </button>
          </ng-template>
        </bf-table-filter>
        <footer>
          <button mat-button (click)="removeContract(i)" test-id="delete-contract">
            Delete all the rights for the title
          </button>
        </footer>
      </section>
    </ng-container>

    <footer fxLayout="column" fxLayoutAlign="center center" class="summary" test-id="footer-total-price">
      <p test-id="total-price">Total Bucket Price: {{ bucket | bucketTotalPrice | currency:bucket.currency }}</p>
      <button mat-flat-button color="accent" (click)="createOffer(bucket)" test-id="create-offer">Create Offer</button>
    </footer>
  </ng-container>
</ng-container>

<ng-template #empty>
  <section class="empty" fxLayout="column" fxLayoutAlign="center center" fxLayoutGap="16px">
    <h1>You have no Rights in your Selection</h1>
    <img asset="no_titles.webp" alt="No rights in selection">
    <button mat-flat-button color="primary" [routerLink]="['/c/o/marketplace/title']">Discover Titles</button>
  </section>
</ng-template>
