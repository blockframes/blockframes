<!-- TODO #1146 header stays? -->
<header class="banner" fxLayout="column" fxLayoutAlign="center center" fxLayoutAlign.xs="center center"
  fxLayoutGap="20px">
  <h3 class="searchbar-header">Find the content you're looking for</h3>
  <!-- Desktop version -->
  <ng-container *ngIf="!isMobile">
    <div class="searchbar-section">
      <form [formGroup]="searchbarForm">
        <mat-form-field appearance="outline">
          <mat-label>Find a content</mat-label>
          <div fxLayout="row nowrap" fxLayoutAlign="end center" class="input-form">
            <input matInput type="text" [formControl]="searchbarTextControl" autocomplete="off"
              [matAutocomplete]="searchbar" #autoCompleteInput>
            <mat-select placeholder="Search by ..." formControlName="type" class="searchbar-select"
              (openedChange)="toggleAutoCompletion()" required>
              <mat-option *ngFor="let option of searchbarOptions" [value]="option">{{ option | titlecase }}
              </mat-option>
            </mat-select>
            <mat-autocomplete #searchbar="matAutocomplete" (optionSelected)="addSearchbarValue($event)">
              <mat-option *ngFor="let result of (resultFilter$ | async)" [value]="result">
                {{ result }}
              </mat-option>
            </mat-autocomplete>
            <button mat-icon-button matSuffix>
              <mat-icon>search</mat-icon>
            </button>
          </div>
        </mat-form-field>
      </form>
    </div>
    <mat-hint>Please choose a value from the selection</mat-hint>
  </ng-container>
  <!-- Mobile version -->
  <ng-container *ngIf="isMobile">
    <div class="searchbar" fxLayout="column">
      <form [formGroup]="searchbarForm">
        <mat-form-field appearance="outline">
          <mat-label>Find a content</mat-label>
          <input matInput type="text" [formControl]="searchbarTextControl" autocomplete="off"
            [matAutocomplete]="searchbarMobile">
          <mat-autocomplete #searchbarMobile="matAutocomplete" (optionSelected)="addSearchbarValue($event)">
            <mat-option *ngFor="let result of (resultFilter$ | async)" [value]="result">
              {{ result }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </form>
      <mat-chip-list fxLayout="row" fxLayoutGap="5px">
        <mat-chip *ngFor="let option of searchbarOptions" [value]="option"
          [ngClass]="{'active': option === searchbarTypeForm.value}" (click)="selectSearchType(option)">
          {{ option | titlecase }}
        </mat-chip>
      </mat-chip-list>
    </div>
  </ng-container>
</header>

<section fxLayout="row" fxLayoutAlign="start start" fxLayoutGap="50px" fxLayout.lt-md="column"
  fxLayoutAlign.lt-md="center center">
  <!-- Search -->
  <aside fxLayout="column" class="filter" [formGroup]="filterForm">
    <mat-card>
      <mat-card-title>Filters</mat-card-title>
      <mat-card-content>
        <mat-accordion multi="true">

          <!-- Production Year -->
          <!-- TODO #1146 -->
          <!-- <mat-expansion-panel expanded>
            <mat-expansion-panel-header>
              <mat-panel-title test-id="production-year-panel">
                Production Year
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div fxLayout="row" fxLayoutAlign="start start" fxLayoutGap="10px" formGroupName="productionYear">
              <mat-form-field appearance="outline">
                <mat-label>From</mat-label>
                <input test-id="production-year-input-from" matInput type="number" formControlName="from"
                  placeholder="From" autocomplete="off" [errorStateMatcher]="matcher" />
                <mat-error *ngIf="filterForm.get('productionYear').get('from').hasError('pattern')">
                  Please type in a valid year! Example: <i>{{ getCurrentYear }}</i>
                </mat-error>
                <mat-error *ngIf="filterForm.get('productionYear').get('from').hasError('max')">
                  The year can't be above the current year, {{ getCurrentYear }}
                </mat-error>
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>To</mat-label>
                <input test-id="production-year-input-to" matInput type="number" formControlName="to" placeholder="To"
                  autocomplete="off" [errorStateMatcher]="matcher" />
                <mat-error *ngIf="filterForm.get('productionYear').get('to').hasError('pattern')">
                  Please type in a valid year! Example: <i>{{ getCurrentYear }}</i>
                </mat-error>
              </mat-form-field>
            </div>
            <mat-error *ngIf="showFormGroupError('productionYear')">
              The value <i>To</i> can't be smaller than the value <i>From</i>!
            </mat-error>
          </mat-expansion-panel> -->

          <!-- Genres -->
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title test-id="genres-panel">
                Genres
              </mat-panel-title>
            </mat-expansion-panel-header>
            <mat-form-field class="genres-chip-list">
              <mat-chip-list #genreChipList aria-label="Genres selection">
                <mat-chip *ngFor="let genre of selectedGenres" selectable removable (removed)="removeGenre(genre)">
                  {{ genre }}
                  <mat-icon matChipRemove *ngIf="removable">cancel</mat-icon>
                </mat-chip>
                <input placeholder="Genres" #genreInput [formControl]="genreControl" [matAutocomplete]="genre"
                  [matChipInputFor]="genreChipList">
              </mat-chip-list>
              <mat-autocomplete #genre="matAutocomplete" (optionSelected)="addGenre($event)">
                <mat-option *ngFor="let genre of (genresFilter$ | async)" [value]="genre">
                  {{ genre }}
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </mat-expansion-panel>

          <!-- Languages -->
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title test-id="languages-panel">
                Languages
              </mat-panel-title>
            </mat-expansion-panel-header>
            <form formGroupName="languages" fxLayout="column">
              <div fxLayout="row" fxLayoutAlign="start start">
                <mat-form-field appearance="outline">
                  <mat-label>New language</mat-label>
                  <input test-id="languages-panel-input" matInput type="text" [matAutocomplete]="language"
                    [formControl]="languageControl" placeholder="Add new language" [errorStateMatcher]="matcher" />
                  <mat-error *ngIf="languageControl.hasError('languageNotSupported')">
                    Please enter a valid language or choose from the dropdown menu!
                  </mat-error>
                  <button matSuffix mat-icon-button (click)="addLanguage(languageControl.value)"
                    [disabled]="!languageControl.valid">
                    <mat-icon>search</mat-icon>
                  </button>
                  <mat-autocomplete #language="matAutocomplete" (optionSelected)="addLanguage(languageControl.value)">
                    <mat-option *ngFor="let language of languagesFilter$ | async" [value]="language">
                      {{language}}
                    </mat-option>
                  </mat-autocomplete>
                </mat-form-field>
                <button test-id="languages" mat-button [disabled]="!languageControl.valid" color="accent"
                  (click)="addLanguage(languageControl.value); languageControl.reset()">Add
                  language
                </button>
              </div>
              <ng-container *ngIf="filterForm.get('languages').value">
                <mat-list [formGroup]="filterForm.get('languages')" role="list">
                  <ng-container *ngFor="let language of languages$ | async">
                    <mat-list-item [formGroupName]="language">
                      <span mat-line>
                        <h3 class="mat-h3">{{ language | translateSlug: 'LANGUAGES' }}</h3>
                        <button mat-icon-button (click)="removeLanguage(language)">
                          <mat-icon class="cancel-btn">cancel</mat-icon>
                        </button>
                      </span>
                      <i mat-line>Options are cumulative</i>
                      <mat-checkbox test-id="languages-checkbox-original" mat-line formControlName="original">Original
                      </mat-checkbox>
                      <mat-checkbox test-id="languages-checkbox-dubbed" mat-line formControlName="dubbed">Dubbed
                      </mat-checkbox>
                      <mat-checkbox test-id="languages-checkbox-subtitle" mat-line formControlName="subtitle">
                        Subtitles
                      </mat-checkbox>
                    </mat-list-item>
                  </ng-container>
                </mat-list>
              </ng-container>
            </form>
          </mat-expansion-panel>

          <!-- Production Statuses -->
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title test-id="status-panel">
                Production Status
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div fxLayout="column" fxLayoutAlign="start space-between" class="filter-checkboxes-status">
              <mat-checkbox (change)="hasStatus(status)" *ngFor="let status of movieProductionStatuses">
                {{status}}
              </mat-checkbox>
            </div>
          </mat-expansion-panel>

          <!-- Sales Agents -->
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title test-id="sales-agent-panel">
                Sales Agents
              </mat-panel-title>
            </mat-expansion-panel-header>
            <mat-form-field class="sales-agents-chip-list">
              <mat-chip-list #salesAgentChipList aria-label="Sales Agents selection">
                <mat-chip *ngFor="let salesAgent of selectedSalesAgents" selectable removable
                  (removed)="removeSalesAgent(salesAgent)">
                  {{ salesAgent }}
                  <mat-icon matChipRemove *ngIf="removable">cancel</mat-icon>
                </mat-chip>
                <input placeholder="Sales Agents" #salesAgentInput [formControl]="salesAgentControl"
                  [matAutocomplete]="salesAgent" [matChipInputFor]="salesAgentChipList">
              </mat-chip-list>
              <mat-autocomplete #salesAgent="matAutocomplete" (optionSelected)="addSalesAgent($event)">
                <mat-option *ngFor="let salesAgent of salesAgentFilter$ | async" [value]="salesAgent">
                  {{ salesAgent }}
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </mat-expansion-panel>

          <!-- Certifications -->
          <!-- TODO #1146 -->
          <!-- <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title test-id="certifications-panel">
                  Certifications
                </mat-panel-title>
              </mat-expansion-panel-header>
              <h6>You can choose multiple certifications</h6>
              <span fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
                <mat-checkbox *ngFor="let certification of movieCertifications"
                  (change)="checkCertification(certification)">{{certification}}
                </mat-checkbox>
              </span>
            </mat-expansion-panel> -->

          <!-- Availabilities -->
          <!-- TODO #1146 -->
          <!-- <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title test-id="availabilities-panel">
                  Availabilities
                </mat-panel-title>
              </mat-expansion-panel-header>
              <div fxLayout="row" fxLayoutAlign="start start" fxLayoutGap="10px" formGroupName="availabilities">
                <mat-form-field appearance="outline">
                  <mat-label>From</mat-label>
                  <input matInput formControlName="from" [matDatepicker]="pickerAvailableFrom" placeholder="From" />
                  <mat-error *ngIf="filterForm.get('availabilities').get('from').hasError('min')">
                    You only can choose the current year and above.
                  </mat-error>
                  <mat-datepicker-toggle test-id="datepicker-from" matSuffix [for]="pickerAvailableFrom">
                  </mat-datepicker-toggle>
                  <mat-datepicker #pickerAvailableFrom startView="multi-year"></mat-datepicker>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>To</mat-label>
                  <input matInput formControlName="to" [matDatepicker]="pickerAvailableTo" placeholder="To" />
                  <mat-datepicker-toggle test-id="datepicker-to" matSuffix [for]="pickerAvailableTo">
                  </mat-datepicker-toggle>
                  <mat-datepicker #pickerAvailableTo startView="multi-year" startAt="2019"></mat-datepicker>
                </mat-form-field>
              </div>
              <mat-error *ngIf="filterForm.get('availabilities').hasError('invalidRange')">
                The value <i>To</i> can't be smaller than the value <i>From</i>!
              </mat-error>
            </mat-expansion-panel> -->

          <!-- Territories -->
          <!-- TODO #1146 -->
          <!-- <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title test-id="territories-panel">
                  Territories
                </mat-panel-title>
              </mat-expansion-panel-header>
              <mat-form-field appearance="outline">
                <mat-chip-list #chipList>
                  <mat-chip *ngFor="let territory of selectedMovieTerritories; let i = index" [selectable]="selectable"
                    [removable]="removable" (removed)="removeTerritory(territory, i)">
                    {{territory}}
                    <mat-icon matChipRemove *ngIf="removable">cancel</mat-icon>
                  </mat-chip>
                  <input test-id="territories-panel-input" placeholder="Territories available" #territoryInput
                    [matAutocomplete]="auto" [matChipInputFor]="chipList" [formControl]="territoryControl" />
                </mat-chip-list>
                <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selectedTerritory($event)">
                  <mat-option *ngFor="let territory of territoriesFilter$ | async" [value]="territory">
                    {{territory}}
                  </mat-option>
                </mat-autocomplete>
                <mat-hint>Please choose a territory out of the drop down menu!</mat-hint>
              </mat-form-field>
            </mat-expansion-panel> -->

          <!-- Mandate Medias -->
          <!-- TODO #1146 -->
          <!-- <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title test-id="mandate-medias-panel">
                  Mandate Medias
                </mat-panel-title>
              </mat-expansion-panel-header>
              <div fxLayout="column" fxLayoutAlign="start space-between" class="filter-checkboxes-media">
                <mat-checkbox *ngFor="let media of movieMedias" (change)="checkMedia(media)">
                  {{media}}
                </mat-checkbox>
              </div>
            </mat-expansion-panel> -->

        </mat-accordion>
      </mat-card-content>
    </mat-card>
  </aside>

  <!-- List || card of result -->
  <article>
    <div class="movies" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
      <h2>Line-up</h2>
      <mat-divider></mat-divider>
      <button mat-icon-button (click)="listView = !listView">
        <ng-container *ngIf="!listView">
          <mat-icon>list</mat-icon>
        </ng-container>
        <ng-container *ngIf="listView">
          <mat-icon>grid_on</mat-icon>
        </ng-container>
      </button>
      <mat-form-field>
        <mat-label>Sort by</mat-label>
        <mat-select [formControl]="sortByControl">
          <mat-option *ngFor="let option of sortOptions" [value]="option">
            {{option}}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div fxLayout="row wrap" fxLayoutGap="30px" *ngIf="(movieSearchResults$ | async) as movies" fxLayout.lt-md="column"
      fxLayoutAlign.lt-md="center center">
      <ng-container *ngFor="let index of movies">
        <movie-card [movie]="index.movie" [link]="['/layout/o/catalog',  index.movie.id]" *ngIf="!listView">
          <ng-container movieInformation>
            <mat-card-subtitle>
              <span *ngFor="let director of index.movie.main.directors; let isLast=last">{{ director.firstName }}
                {{ director.lastName }}{{isLast ? '' : ', '}}</span>
            </mat-card-subtitle>
            <mat-card-content class="table-size-text">
              <b *ngFor="let country of index.movie.main.originCountries | slice:0:2; let isLast=last; let i=index">
                {{ country | translateSlug: 'TERRITORIES' }}{{isLast ? '' : ', '}}{{i == 1 && index.movie.main.originCountries.length > 2 ? ',  ' : ''}}
              </b>
              <b *ngIf="index.movie.main.originCountries.length > 2">... </b>
              <b *ngIf="index.movie.main.length">| {{ index.movie.main.length }} min </b><b>|
                {{ index.movie.main.genres[0] | translateSlug: 'GENRES'}}</b>
              <p *ngIf="index.movie.salesAgentDeal.salesAgent.displayName">
                {{ index.movie.salesAgentDeal.salesAgent.displayName}}
              </p>
            </mat-card-content>
          </ng-container>
          <ng-container movieCardAction>
            <div fxLayout="row" fxLayoutAlign="end">
              <ng-container *ngIf="(toggle$(index.movie.id) | async); else alreadyAdded">
                <button mat-icon-button (click)="removeFromWishlist(index.movie)">
                  <mat-icon svgIcon="heart_filled"></mat-icon>
                </button>
              </ng-container>
              <ng-template #alreadyAdded>
                <button mat-icon-button (click)="addToWishlist(index.movie)">
                  <mat-icon svgIcon="heart"></mat-icon>
                </button>
              </ng-template>
            </div>
          </ng-container>
        </movie-card>
      </ng-container>
      <!-- We don't iterate over the movies here, cause this will be done by the mat tables -->
      <movie-display-list [movies]="movies" *ngIf="listView" (navigate)="goToMovieDetails($event)">
      </movie-display-list>
    </div>
    <div fxLayout="row" fxLayoutAlign="end start">
      <h6>There are {{ availableMovies }} movies available!</h6>
    </div>
  </article>
</section>
