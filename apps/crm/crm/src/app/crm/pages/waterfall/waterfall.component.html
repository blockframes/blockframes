<ng-container *ngIf="waterfall && movie">
  <article>
    <movie-header [movie]="movie"></movie-header>
  </article>

  <mat-tab-group>
    <!-- RIGHTHOLDERS -->
    <mat-tab label="Right Holders">
      <bf-table [source]="rightholders" clickable useFilter pagination="50">
        <ng-template colRef="id" label="Id" let-id sort defaultSort>
          {{ id }}
        </ng-template>
        <ng-template colRef="name" label="Name" let-name sort>
          {{ name }}
        </ng-template>
        <ng-template colRef="roles" label="Roles" let-roles sort>
          {{ roles | toLabel: 'rightholderRoles' }}
        </ng-template>
      </bf-table>
    </mat-tab>
    <!-- DOCUMENTS -->
    <mat-tab label="All Documents">
      <bf-table [source]="documents" clickable useFilter pagination="50" (rowClick)="goToDocument($event.id)">
        <ng-template colRef="id" label="Id" let-id sort defaultSort>
          {{ id }}
        </ng-template>
        <ng-template colRef="signatureDate" label="Signature Date" let-signatureDate sort>
          {{ signatureDate | date: 'MM/dd/yyyy' }}
        </ng-template>
        <ng-template colRef="rootId" label="Parent" let-rootId sort>
          {{ rootId ? rootId : '--' }}
        </ng-template>
        <ng-template colRef="type" label="Type" let-type sort>
          {{ type }}
        </ng-template>
        <ng-template colRef="id" label="Action" let-documentId sticky>
          <a mat-icon-button target="_blank" [routerLink]="['/c/o/dashboard/crm/waterfall', waterfall.id, 'document', documentId]" (click)="$event.stopPropagation()">
            <mat-icon svgIcon="launch"></mat-icon>
          </a>
          <button mat-icon-button (click)="removeDocument(documentId)">
            <mat-icon svgIcon="delete" matTooltip="Delete document"></mat-icon>
          </button>
        </ng-template>
      </bf-table>
    </mat-tab>
    <!-- SOURCES -->
    <mat-tab label="Sources">
      <bf-table [source]="sources" clickable useFilter pagination="50">
        <ng-template colRef="id" label="Id" let-id sort defaultSort>
          {{ id }}
        </ng-template>
        <ng-template colRef="name" label="Name" let-name sort>
          {{ name }}
        </ng-template>
        <ng-template colRef="medias" label="Medias" let-medias sort>
          <mat-chip-list *ngIf="medias.length else noMedias" aria-label="Medias">
            <mat-chip disableRipple *ngFor="let media of medias  | toGroupLabel:'medias':'All'">
              {{ media }}
            </mat-chip>
          </mat-chip-list>
          <ng-template #noMedias>--</ng-template>
        </ng-template>
        <ng-template colRef="territories" label="Territories" let-territories sort>
          <span *ngIf="territories.length else noTerritories" class="group-label" (click)="openTerritoryModal(territories)">
            {{ territories | toGroupLabel:'territories':'World' | join | maxLength:30 }}
          </span>
          <ng-template #noTerritories>--</ng-template>
        </ng-template>
        <ng-template colRef="destinationId" label="Destination Right" let-destinationId sort>
          {{ destinationId }}
        </ng-template>
        <ng-template colRef="id" label="Action" let-sourceId sticky>
          <button mat-icon-button (click)="removeSource(sourceId)">
            <mat-icon svgIcon="delete" matTooltip="Delete source"></mat-icon>
          </button>
        </ng-template>
      </bf-table>
    </mat-tab>
    <!-- CONTRACTS -->
    <mat-tab label="Contracts">
      <bf-table [source]="contracts" clickable useFilter pagination="50" (rowClick)="goToDocument($event.id)">
        <ng-template colRef="id" label="Id" let-id sort defaultSort>
          {{ id }}
        </ng-template>
        <ng-template colRef="signatureDate" label="Signature Date" let-signatureDate sort>
          {{ signatureDate | date: 'MM/dd/yyyy' }}
        </ng-template>
        <ng-template colRef="rootId" label="Parent" let-rootId sort>
          {{ rootId ? rootId : '--' }}
        </ng-template>
        <ng-template colRef="sellerId" label="Licensor" let-sellerId sort>
          <ng-container *ngIf="sellerId as org">
            {{ getRightholderName(sellerId) }}
          </ng-container>
        </ng-template>
        <ng-template colRef="buyerId" label="Licensee" let-buyerId sort>
          <ng-container *ngIf="buyerId async as org">
            {{ getRightholderName(buyerId) }}
          </ng-container>
        </ng-template>
        <ng-template colRef="" label="Price" let-item sort>
          <ng-container *ngIf="getDeclaredAmount(item) as amount">
            <price-per-currency [price]="amount"></price-per-currency>
          </ng-container>
        </ng-template>
        <ng-template colRef="type" label="Type" let-type sort>
          {{ type }}
        </ng-template>
        <ng-template colRef="id" label="Action" let-documentId sticky>
          <a mat-icon-button target="_blank" [routerLink]="['/c/o/dashboard/crm/waterfall', waterfall.id, 'document', documentId]" (click)="$event.stopPropagation()">
            <mat-icon svgIcon="launch"></mat-icon>
          </a>
          <button mat-icon-button (click)="removeDocument(documentId)">
            <mat-icon svgIcon="delete" matTooltip="Delete document"></mat-icon>
          </button>
        </ng-template>
      </bf-table>
    </mat-tab>
    <!-- INCOMES -->
    <mat-tab label="Incomes">
      <bf-table [source]="incomes" clickable useFilter pagination="50">
        <ng-template colRef="id" label="Id" let-id sort defaultSort>
          {{ id }}
        </ng-template>
        <ng-template colRef="" label="Contract Id" let-item sort>
          {{ getCurrentContract(item) }}
        </ng-template>
        <ng-template colRef="date" label="Date" let-date sort>
          {{ date | date: 'MM/dd/yyyy' }}
        </ng-template>
        <ng-template colRef="" label="Source" let-item sort>
          {{ getAssociatedSource(item) }}
        </ng-template>
        <ng-template colRef="" label="Price" let-item sort>
          <ng-container *ngIf="getPrice(item) as amount">
            <price-per-currency [price]="amount"></price-per-currency>
          </ng-container>
        </ng-template>
      </bf-table>
    </mat-tab>
    <!-- EXPENSES -->
    <mat-tab label="Expenses">
      <bf-table [source]="expenses" clickable useFilter pagination="50">
        <ng-template colRef="id" label="Id" let-id sort defaultSort>
          {{ id }}
        </ng-template>
        <ng-template colRef="" label="Contract Id" let-item sort>
          {{ getCurrentContract(item) }}
        </ng-template>
        <ng-template colRef="date" label="Date" let-date sort>
          {{ date | date: 'MM/dd/yyyy' }}
        </ng-template>
        <ng-template colRef="category" label="Category" let-category sort>
          {{ category }}
        </ng-template>
        <ng-template colRef="type" label="Type" let-type sort>
          {{ type }}
        </ng-template>
        <ng-template colRef="" label="Price" let-item sort>
          <ng-container *ngIf="getPrice(item) as amount">
            <price-per-currency [price]="amount"></price-per-currency>
          </ng-container>
        </ng-template>
      </bf-table>
    </mat-tab>
    <!-- VERSIONS -->
    <mat-tab label="Versions & Actions" #versionsAndActions>
      <ng-container *ngIf="versions.length else noWaterfall">
        <h3>Versions</h3>
        <bf-table [source]="versions" clickable useFilter pagination="50">
          <ng-template colRef="id" label="Id" let-id sort defaultSort>
            {{ id }}
          </ng-template>
          <ng-template colRef="name" label="Name" let-name sort>
            {{ name }}
          </ng-template>
          <ng-template colRef="description" label="Description" let-description sort>
            {{ description }}
          </ng-template>
          <ng-template colRef="blockIds" label="Blocks" let-blockIds sort>
            {{ blockIds.length }} block(s)
          </ng-template>
          <ng-template colRef="id" label="Actions" let-versionId sticky>
            <button mat-icon-button (click)="removeVersion(versionId)">
              <mat-icon svgIcon="delete" matTooltip="Delete version"></mat-icon>
            </button>
            <button mat-icon-button (click)="duplicateVersion(versionId)">
              <mat-icon svgIcon="file_copy" matTooltip="Duplicate version"></mat-icon>
            </button>
            <button mat-icon-button (click)="displayActions(versionId)">
              <mat-icon svgIcon="search" matTooltip="Show actions"></mat-icon>
            </button>
            <button mat-icon-button (click)="displayWaterfall(versionId)">
              <mat-icon svgIcon="star" matTooltip="Show waterfall"></mat-icon>
            </button>
          </ng-template>
        </bf-table>
      </ng-container>
      
      <ng-template #noWaterfall>
        <section>
          <h1>Waterfall not initialized.</h1>
          <p class="mat-body-1">
            Please initalize a first version that you're going to work with.
          </p>
          <a (click)="initWaterfall()" class="surface">
            <img asset="add_draft.svg" alt="Add waterfall image">
            <button mat-button color="primary">Initialize Waterfall</button>
          </a>
        </section>
      </ng-template>

      <ng-container *ngIf="actions.length">
        <h3>Actions</h3>
        <bf-table [source]="actions" clickable useFilter pagination="50">
          <ng-template colRef="actionId" label="Id" let-actionId>
            {{ actionId }}
          </ng-template>
          <ng-template colRef="payload.date" label="Date" let-date sort>
            {{ date | date: 'MM/dd/yyyy' }}
          </ng-template>
          <ng-template colRef="blockId" label="Block" let-blockId sort>
            {{ blockId }}
          </ng-template>
          <ng-template colRef="name" label="Name" let-name sort>
            {{ name }}
          </ng-template>
        </bf-table>
      </ng-container>

      <ng-container *ngIf="tree">
        <h3>Waterfall</h3>
        <waterfall-g6-graph [tree]="tree"></waterfall-g6-graph>
      </ng-container>
      

      <ng-container *ngIf="versions.length else noWaterfall">
        <h3>Tree</h3>
        <article class="surface">
          <waterfall-g6-tree *ngIf="versionsAndActions.isActive" [waterfall]="waterfall"></waterfall-g6-tree>
        </article>
      </ng-container>
    </mat-tab>

    <!-- WORLD MAP -->
    <mat-tab label="World Sales" #worldSales>
      <waterfall-sales-map *ngIf="worldSales.isActive" [waterfallId]="waterfall.id"></waterfall-sales-map>
    </mat-tab>
  </mat-tab-group>
</ng-container>
