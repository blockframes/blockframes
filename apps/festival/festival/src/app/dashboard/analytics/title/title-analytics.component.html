<header fxLayout="column" fxLayoutGap="20px" class="dark-contrast-theme" bgAsset="background_header.png" bgTheme="dark">
  <button mat-icon-button (click)="goBack()">
    <mat-icon svgIcon="arrow_back"></mat-icon>
  </button>

  <ng-container *ngIf="title$ | async as title">
    <article fxLayout fxLayoutGap="24px">
      <a [routerLink]="['/c/o/marketplace/title/', title.id]">
        <img fxHide.lt-md [ref]="title.poster" asset="empty_poster.svg" alt="Movie Poster" class="poster">
      </a>

      <div fxFlex fxLayout="column">
        <p class="mat-body-1">{{ title.directors | displayName }}</p>
        <div fxLayout fxLayoutAlign="space-between">
          <h1 class="mat-display-1">{{ title.title.international }}</h1>
          <a mat-button [routerLink]="['/c/o/marketplace/title/', title.id]" class="film-page-button">See Film Page</a>
        </div>
        <h6>{{ title.genres | toLabel: 'genres' }}</h6>
      </div>
    </article>
  </ng-container>
</header>

<section>
  <article>
    <h2>Interested Users</h2>
    <p class="mat-body-1">See how many users interacted with your movie (viewed your title, added to wishlist, requested a screening, etc).</p>
  </article>

  <article class="surface">
    <a mat-button [routerLink]="['/c/o/dashboard']">
      <mat-icon svgIcon="arrow_back"></mat-icon>
      <span>Come back to Dashboard</span>
    </a>

    <div fxLayout fxLayout.lt-sm="column" fxLayoutGap="16px">
      <analytics-pie-chart fxFlex class="surface" [data]="orgActivity$ | async" (selection)="filterValue = $event"></analytics-pie-chart>
      <analytics-map fxFlex class="surface" [data]="territoryActivity$ | async" selectable (selection)="filterValue = $event">
        <article>
          <h5>
            <mat-icon svgIcon="landscape"></mat-icon>
            <span>Split by Company Territory</span><br/>
          </h5>
          <p class="mat-caption">Learn where are the interested people from.</p>
        </article>
      </analytics-map>
    </div>
  </article>

  <bf-table [source]="buyerAnalytics$ | async" pagination="5" useFilter [filterValue]="filterValue">
    <ng-template colRef="user" label="Name" let-user sort>
      <a [href]="'mailto:' + user?.email">{{ user | displayName }}</a>
    </ng-template>
    <ng-template colRef="user.email" label="Email address" let-email sort>
      {{ email }}
    </ng-template>
    <ng-template colRef="org.denomination.public" label="Company name" let-name sort>
      {{ name }}
    </ng-template>
    <ng-template colRef="org.activity" label="Activity" let-activity sort [filter]="filters.orgActivity">
      {{ activity | toLabel:'orgActivity' }}
    </ng-template>
    <ng-template colRef="org.addresses.main.country" label="Country" let-country sort [filter]="filters.territories">
      {{ country | toLabel:'territories' }}
    </ng-template>
    <ng-template colRef="user.position" label="Position" let-position sort>
      {{ position }}
    </ng-template>
    <ng-template colRef="pageView" label="Views" let-pageView sort>
      {{ pageView }}
    </ng-template>
    <ng-template colRef="promoReelOpened" label="Promo reels" let-promoReelOpened sort>
      {{ promoReelOpened ? promoReelOpened : '-' }}
    </ng-template>
    <ng-template colRef="" label="In wishlist" let-item sort>
      {{ inWishlist(item) ? 'Yes' : '-' }}
    </ng-template>
    <ng-template colRef="screeningRequested" label="Screening requested" let-screeningRequested sort>
      {{ screeningRequested ? 'Yes' : '-' }}
    </ng-template>
    <ng-template colRef="askingPriceRequested" label="Asking price requested" let-askingPriceRequested sort>
      {{ askingPriceRequested ? 'Yes' : '-' }}
    </ng-template>
  </bf-table>
</section>

<header class="heading">
  <h3>
    <span>Last Screenings</span>
    <mat-icon svgIcon="info"></mat-icon>
  </h3>
  <ng-container *ngIf="ongoingScreenings$ | async as events">
    <a ongoing-event-button href="/c/o/dashboard/event/{{events[0].id}}/statistics">Ongoing
      Screenings</a>
  </ng-container>
</header>
<section class="surface">
  <span>"O" meaning the user left the screening right away.</span>
  <analytics-metric-card-list [cards]="aggregatedScreeningCards$ | async"></analytics-metric-card-list>
  <header class="space-between">
    <h5>Attendees</h5>
    <button mat-button (click)="exportScreenerAnalytics()">Export to .CSV</button>
  </header>
  <bf-table class="screenings" [source]="invitations$ | async" clickable useFilter pagination="50">
    <ng-template colRef label="Name" let-invitation="item" sort defaultSort>
      <b *ngIf="invitation.toUser; else noUser">{{ invitation.toUser.firstName }} {{ invitation.toUser.lastName }}</b>
      <ng-template #noUser>
        <b>--</b>
      </ng-template>
    </ng-template>
    <ng-template colRef="toUser.email" label="Email" let-email sort defaultSort>
      <span>{{ email ?? '--' }}</span>
    </ng-template>
    <ng-template colRef="guestOrg.denomination.public" label="Company Name" let-name sort defaultSort>
      <span>{{ name ?? '--' }}</span>
    </ng-template>
    <ng-template colRef="guestOrg.activity" label="Activity" let-activity sort defaultSort>
      <span>{{ activity ?? '--' }}</span>
    </ng-template>
    <ng-template colRef="guestOrg.addresses.main.country" label="Country" let-country sort defaultSort>
      <span>{{ country ?? '--' }}</span>
    </ng-template>
    <ng-template colRef="watchTime" label="Watchtime" let-watchtime sort defaultSort>
      <span>{{ watchtime || 0 }} S</span>
    </ng-template>
  </bf-table>
</section>

