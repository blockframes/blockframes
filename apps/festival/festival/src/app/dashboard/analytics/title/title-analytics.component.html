<header fxLayout="column" fxLayoutGap="20px" class="dark-contrast-theme banner" bgAsset="background_header.png" bgTheme="dark">
  <button mat-icon-button (click)="goBack()">
    <mat-icon svgIcon="arrow_back"></mat-icon>
  </button>

  <ng-container *ngIf="title$ | async as title">
    <article fxLayout fxLayoutGap="24px">
      <a [routerLink]="['/c/o/dashboard/title/', title.id]">
        <img fxHide.lt-md [ref]="title.poster" asset="empty_poster.svg" alt="Movie Poster" class="poster">
      </a>

      <div fxFlex fxLayout="column">
        <p class="mat-body-1">{{ title.directors | displayName }}</p>
        <div fxLayout fxLayoutAlign="space-between">
          <h1 class="mat-display-1">{{ title.title.international }}</h1>
          <a mat-button [routerLink]="['/c/o/dashboard/title/', title.id]" class="film-page-button">See Film Page</a>
        </div>
        <h6>{{ title.genres | toLabel: 'genres' }}</h6>
      </div>
    </article>
  </ng-container>
</header>

<section>
  <article>
    <h2>Interested Users</h2>
    <p class="mat-body-1">See how many users interacted with your movie (viewed your title, added to wishlist, requested a screening, etc).</p>
  </article>

  <article class="surface">
    <a mat-button [routerLink]="['/c/o/dashboard']">
      <mat-icon svgIcon="arrow_back"></mat-icon>
      <span>Come back to Dashboard</span>
    </a>

    <div fxLayout fxLayout.lt-sm="column" fxLayoutGap="16px">
      <analytics-pie-chart fxFlex class="surface" [data]="orgActivity$ | async" (selection)="filterValue = $event">
        <mat-icon svgIcon="business"></mat-icon>
        <h5>Split by Company Activity</h5>
        <p class="mat-caption">Learn who are the users who were interested in this Title.</p>
      </analytics-pie-chart>
      <analytics-map fxFlex class="surface" [data]="territoryActivity$ | async" selectable (selection)="filterValue = $event">
        <mat-icon svgIcon="landscape"></mat-icon>
        <h5>Split by Company Territory</h5>
        <p class="mat-caption">Learn where are the interested people from.</p>
      </analytics-map>
    </div>
  </article>

  <bf-table [source]="buyerAnalytics$ | async" pagination="5" useFilter [filterValue]="filterValue" (rowClick)="viewBuyerActivity($event)">
    <ng-template colRef="user" label="Name" let-user sort>
      <a [href]="'mailto:' + user?.email">{{ user | displayName }}</a>
    </ng-template>
    <ng-template colRef="user.email" label="Email address" let-email sort>
      {{ email }}
    </ng-template>
    <ng-template colRef="org" label="Company name" let-org sort>
      {{ org | orgName }}
    </ng-template>
    <ng-template colRef="org.activity" label="Activity" let-activity sort [filter]="filters.orgActivity">
      {{ activity | toLabel:'orgActivity' }}
    </ng-template>
    <ng-template colRef="org.addresses.main.country" label="Country" let-country sort [filter]="filters.territories">
      {{ country | toLabel:'territories' }}
    </ng-template>
    <ng-template colRef="user.position" label="Position" let-position sort>
      {{ position }}
    </ng-template>
    <ng-template colRef="pageView" label="Views" let-pageView sort>
      {{ pageView }}
    </ng-template>
    <ng-template colRef="promoReelOpened" label="Video Plays" let-videoPlays sort>
      {{ videoPlays ? videoPlays : '-' }}
    </ng-template>
    <ng-template colRef="" label="In wishlist" let-item sort>
      {{ inWishlist(item) ? 'Yes' : '-' }}
    </ng-template>
    <ng-template colRef="screeningRequested" label="Screening requested" let-screeningRequested sort>
      {{ screeningRequested ? 'Yes' : '-' }}
    </ng-template>
    <ng-template colRef="askingPriceRequested" label="Asking price requested" let-askingPriceRequested sort>
      {{ askingPriceRequested ? 'Yes' : '-' }}
    </ng-template>
  </bf-table>

  <h3>Vanity Metrics</h3>
  <article class="surface vanity_metrics">
    <analytics-line-chart class="surface" [eventNames]="['pageView']" [data]="titleAnalytics$ | async">
      <mat-icon svgIcon="visibility"></mat-icon>
      <h5>Film Page Views</h5>
      <p class="mat-caption">See how many Buyers viewed your Film Page recently.</p>
    </analytics-line-chart>
    <analytics-line-chart class="surface" [eventNames]="interactions" [data]="titleInteractions$ | async">
      <mat-icon svgIcon="switch_access_shortcut"></mat-icon>
      <h5>Interactions</h5>
      <p class="mat-caption">Learn how people interact with your Title.</p>
    </analytics-line-chart>
  </article>

  <header>
    <h3>Last Screenings</h3>
    <mat-icon svgIcon="info" matTooltip="Statistics are updated in real time."></mat-icon>
    <ng-container *ngIf="ongoingScreenings$ | async as events">
      <a ongoing-event-button routerLink="/c/o/dashboard/event/{{events[0].id}}/statistics">Ongoing
        Screenings</a>
    </ng-container>
  </header>
  <article class="surface">
    <p>"0" means the user left the screening right away.</p>
    <analytics-metric-card-list [cards]="aggregatedScreeningCards$ | async"></analytics-metric-card-list>
    <ng-container *ngIf="invitations$ | async as invitations">
      <header>
        <h5>Attendees</h5>
        <button mat-button color="primary" [disabled]="!invitations.length" (click)="exportScreenerAnalytics()">Export to .CSV</button>
      </header>
      <bf-table class="screenings" [source]="invitations" clickable useFilter pagination="5" (rowClick)="goToBuyer($event)">
        <ng-template colRef label="Name" let-invitation="item" sort defaultSort [filter]="filters.name">
          <b>{{ invitation | guest:'user' | displayName }}</b>
        </ng-template>
        <ng-template colRef label="Email" let-invitation="item" sort defaultSort [filter]="filters.email">
          <span>{{ (invitation | guest: 'user').email }}</span>
        </ng-template>
        <ng-template colRef="guestOrg.denomination.public" label="Company Name" let-name sort defaultSort>
          <span>{{ name ?? '-' }}</span>
        </ng-template>
        <ng-template colRef="guestOrg.activity" label="Activity" let-activity sort defaultSort [filter]="filters.orgActivity">
          <span *ngIf="activity else noActivity">{{ activity | toLabel: 'orgActivity' }}</span>
          <ng-template #noActivity>-</ng-template>
        </ng-template>
        <ng-template colRef="guestOrg.addresses.main.country" label="Country" let-country sort defaultSort [filter]="filters.territories">
          <span *ngIf="country else noCountry">
            {{ country | toLabel:'territories' }}
          </span>
          <ng-template #noCountry>-</ng-template>
        </ng-template>
        <ng-template colRef="watchTime" label="Watch Time" let-watchtime sort defaultSort>
          <span>{{ watchtime * 1000 | duration: '0s' }}</span>
        </ng-template>
      </bf-table>
    </ng-container>
  </article>
</section>

