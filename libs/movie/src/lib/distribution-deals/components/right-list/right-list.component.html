<ng-container *ngIf="dataSource.data.length">
  <section *ngIf="displayedColumns$ | async as displayedColumns" fxLayout="column" fxLayoutAlign="center end">
    <button matSuffix mat-icon-button [widgetTarget]="filterColumnWidget">
      <mat-icon>filter_list</mat-icon>
    </button>
    <table mat-table [dataSource]="dataSource" matSort>
      <ng-container matColumnDef="territory">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Territory </th>
        <td mat-cell *matCellDef="let deal">
          <ng-container *ngIf="getDealTerritories(deal) as territories">
            <b> {{ territories | slice:0:4 | translateSlug: 'TERRITORIES' }} </b>
            <b *ngIf="territories.length > 4" [widgetTooltip]="territory">...</b>
            <overlay-widget #territory>
              <widget-card>
                <b *ngIf="territories.length > 4">
                  {{ territories | slice:4:territories.length | translateSlug: 'TERRITORIES' }}
                </b>
              </widget-card>
            </overlay-widget>
          </ng-container>
        </td>
      </ng-container>

      <ng-container matColumnDef="startDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Start Date </th>
        <td mat-cell *matCellDef="let deal">
          <ng-container *ngIf="deal.terms.start as start">
            {{ start | date:'shortDate' }}
          </ng-container>
        </td>
      </ng-container>

      <ng-container matColumnDef="endDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> End Date </th>
        <td mat-cell *matCellDef="let deal">
          <ng-container *ngIf="deal.terms.end as end">
            {{ end | date:'shortDate' }}
          </ng-container>
        </td>
      </ng-container>

      <ng-container matColumnDef="rights">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Rights </th>
        <td mat-cell *matCellDef="let deal">
          <b *ngFor="let media of deal.licenseType; let isLast = last">
            {{ media | translateSlug: 'MEDIAS' }}{{isLast ? '' : ', '}}
          </b>
        </td>
      </ng-container>

      <ng-container matColumnDef="languages">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Languages </th>
        <td mat-cell *matCellDef="let deal">
        </td>
      </ng-container>

      <ng-container matColumnDef="holdback">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Holdback </th>
        <td mat-cell *matCellDef="let deal">
        </td>
      </ng-container>

      <ng-container matColumnDef="firstBroadcastDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> 1st Broadcast Date </th>
        <td mat-cell *matCellDef="let deal">
          <ng-container *ngIf="deal.multidiffusion && deal.multidiffusion.length">
            <ng-container *ngIf="deal.multidiffusion[0].start as start">
              {{ start | date:'shortDate' }}
            </ng-container>
          </ng-container>
        </td>
      </ng-container>

    <ng-container matColumnDef="exclusive">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Exclusive </th>
      <td mat-cell *matCellDef="let deal">
        {{ deal.exclusive ? 'Yes' : 'No' }}
      </td>
    </ng-container>

      <ng-container matColumnDef="multidiffusion">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Multidiffusion </th>
        <td mat-cell *matCellDef="let deal">
          <ng-container *ngIf="deal.multidiffusion">
            {{ deal.multidiffusion.length }}
          </ng-container>
        </td>
      </ng-container>

      <ng-container matColumnDef="catchUp">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Catch Up </th>
        <td mat-cell *matCellDef="let deal">
          <ng-container *ngIf="deal.catchUp as catchUp">
            <ng-container *ngIf="catchUp.start && catchUp.end">
              {{ deal.catchUp.start.toDate() | date:'shortDate' }} - {{ deal.catchUp.end.toDate() | date:'shortDate' }}
            </ng-container>
          </ng-container>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </section>

  <overlay-widget #filterColumnWidget >
    <widget-card>
      <mat-selection-list [formControl]="columnFilter" class="mat-elevation-z2">
        <mat-list-option *ngFor="let column of dealColumns | keyvalue" [value]="column.key">
          {{ column.value }}
        </mat-list-option>
      </mat-selection-list>
    </widget-card>
  </overlay-widget>
</ng-container>
