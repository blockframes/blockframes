<main bgAsset="rocket_background.svg">
  <button app-logo (click)="logout()"></button>
  <section fxLayout="column" fxLayoutAlign="center center">
    <h1>Create your account</h1>
    <p>Please fill in the form below to join the {{ app | appName }} platform.</p>
    <ng-container *ngIf="(user$ | async) === undefined">
      <p class="mat-body-2 text-primary">
        Already have an account? <a routerLink="/auth/connexion">Log in here.</a>
      </p>
    </ng-container>
    <article class="surface" fxLayout="column" fxLayoutAlign="center center">
      <form [formGroup]="form" fxLayout="column">

        <!-- IDENTITY -->
        <mat-form-field class="email-input" appearance="outline" fxFlex>
          <mat-icon matPrefix svgIcon="mail"></mat-icon>
          <mat-label>Email Address</mat-label>
          <input matInput type="email" aria-label="email" formControlName="email" email required test-id="email">
          <mat-error *ngIf="form.get('email').hasError('required')">
            Email Address is <strong>required</strong>.
          </mat-error>
        </mat-form-field>

        <user-hide-email [form]="form.get('hideEmail')"></user-hide-email>

        <article fxFlex fxLayout="row" fxLayoutGap="24px" fxLayout.lt-md="column">
          <mat-form-field appearance="outline">
            <mat-label>First Name</mat-label>
            <input matInput type="text" placeholder="First Name" formControlName="firstName" required test-id="first-name"/>
            <mat-error *ngIf="form.get('firstName').hasError('required')">
              First Name is <strong>required</strong>.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Last Name</mat-label>
            <input matInput type="text" placeholder="Last Name" formControlName="lastName" required test-id="last-name"/>
            <mat-error *ngIf="form.get('lastName').hasError('required')">
              Last Name is <strong>required</strong>.
            </mat-error>
          </mat-form-field>
        </article>

        <!-- ORGANIZATION -->
        <ng-container *ngIf="useAlgolia else orgInput">
          <algolia-autocomplete [indexGroup]="indexGroup" keyToDisplay="name" (selectionChange)="setOrg($event)"
            required [control]="orgControl">
            <ng-template optionRef let-result>
              <div flexLayout="row" class="org-logo" fxLayoutGap="16px" fxLayoutAlign="start center">
                <img [ref]="result.logo | storageFile: 'orgs':'logo':result.id" asset="empty_organization.svg"
                  type="logo" alt="Organization Logo">
                <span>{{ result.name }}</span>
              </div>
            </ng-template>

            <ng-template lastOptionRef let-value>
              <div flexLayout="row" class="org-logo" fxLayoutGap="16px" fxLayoutAlign="start center"
                (click)="createOrg(value)">
                <mat-icon svgIcon="add"></mat-icon> <strong><span> CREATE "{{ value }}" COMPANY</span></strong>
              </div>
            </ng-template>

            <mat-label>Company Name</mat-label>
            <mat-hint>
              Select an existing company from the list or create a new one.
            </mat-hint>
            <mat-error>
              You have to select a choice from the list.
            </mat-error>
          </algolia-autocomplete>
        </ng-container>

        <ng-template #orgInput>
          <mat-form-field appearance="outline">
            <mat-hint *ngIf="existingUser">Your Company Information is pre-filled as we found an invitation matching
              your email address, associating you with an existing company.</mat-hint>
            <mat-label>Company Name*</mat-label>
            <input matInput type="text" [formControl]="orgForm.get('denomination').get('full')" disabled />
          </mat-form-field>
        </ng-template>

        <organization-lite-form *ngIf="!!orgForm.get('denomination').get('full').value" [form]="orgForm">
        </organization-lite-form>

        <!-- PASSWORD FIELDS -->
        <ng-container *ngIf="form.get('generatedPassword').enabled">
          <div fxLayout fxLayoutGap="16px" fxLayoutAlign="start">
            <mat-form-field appearance="outline">
              <mat-label>Invitation Pass</mat-label>
              <input matInput type="password" placeholder="Your Invitation Pass" formControlName="generatedPassword"
              test-id="invitation-code" required />
              <mat-hint>You'll find your Invitation Pass in your invitation email.</mat-hint>
            </mat-form-field>
            <button mat-mini-fab color="primary" matTooltip="Contact us to get help" (click)="openIntercom()">?</button>
          </div>
        </ng-container>

        <mat-form-field appearance="outline" *ngIf="form.get('password').enabled">
          <mat-label>Password</mat-label>
          <input
            matInput
            type="password"
            placeholder="New Password"
            formControlName="password"
            [errorStateMatcher]="currentPasswordMatch"
            required
            test-id="password"
            [type]="hidePassword ? 'password' : 'text'"
          />
          <button type="button" matSuffix mat-icon-button (click)="hidePassword = !hidePassword" [matTooltip]="hidePassword ? 'Show Password' : 'Hide Password'">
            <mat-icon *ngIf="!hidePassword" svgIcon="visibility_off"></mat-icon>
            <mat-icon *ngIf="hidePassword" svgIcon="visibility"></mat-icon>
          </button>
          <mat-hint>Between 6 and 24 characters.</mat-hint>
          <mat-error *ngIf="form.get('password').hasError('required')">
            New password is <strong>required</strong>.
          </mat-error>
          <mat-error *ngIf="form.get('password').hasError('minlength')">
            New password with less than <strong>6</strong> characters.
          </mat-error>
          <mat-error *ngIf="form.get('password').hasError('maxlength')">
            New password with more than <strong>24</strong> characters.
          </mat-error>
          <mat-error *ngIf="form.hasError('currentPasswordMatch')">
            Your new password has to be <strong>different</strong> than current password.
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" *ngIf="form.get('confirm').enabled">
          <mat-label>Password Confirmation</mat-label>
          <input
            matInput
            type="password"
            placeholder="New Password Confirmation"
            formControlName="confirm"
            [errorStateMatcher]="passwordsMatcher"
            required
            test-id="password-confirm"
            [type]="hidePassword ? 'password' : 'text'"
          />
          <button type="button" matSuffix mat-icon-button (click)="hidePassword = !hidePassword" [matTooltip]="hidePassword ? 'Show Password' : 'Hide Password'">
            <mat-icon *ngIf="!hidePassword" svgIcon="visibility_off"></mat-icon>
            <mat-icon *ngIf="hidePassword" svgIcon="visibility"></mat-icon>
          </button>
          <mat-hint>Please rewrite your password for confirmation.</mat-hint>
          <mat-error *ngIf="form.get('confirm').hasError('required')">
            New password confirmation is <strong>required</strong>.
          </mat-error>
          <mat-error *ngIf="form.hasError('passwordsNotMatching')">
            The confirmation password does not <strong>match your password</strong>.
          </mat-error>
        </mat-form-field>

        <!-- TERMS OF USE & PRIVACY POLICY -->
        <div class="privacy" fxLayout="column" fxLayoutAlign="start" fxLayoutGap="16px">
          <mat-checkbox test-id="terms" color="primary" formControlName="termsOfUse">
            <span class="mat-caption">I hereby accept {{ app | appName }}&nbsp;
              <a target="_blank" routerLink="/auth/terms">Terms and Conditions</a>.
            </span>
          </mat-checkbox>

          <mat-checkbox test-id="gdpr" color="primary" formControlName="privacyPolicy">
            <span class="mat-caption">I hereby accept the Processing of my Personal Data and declare to know&nbsp;
              <a target="_blank" routerLink="/auth/privacy">the Conditions of such Processing and my rights under GDPR Regulation</a>.
            </span>
          </mat-checkbox>
        </div>
      </form>

      <ng-container *ngIf="!creating else creatingAccount">
        <button @slideDown (click)="signUp()" type="submit" mat-flat-button color="accent"
          [disabled]="form.invalid || orgForm.invalid" test-id="submit"
        >
          Sign up
        </button>
      </ng-container>
      <ng-template #creatingAccount>
        <button @slideUp mat-flat-button disabled>
          Creating account...
        </button>
      </ng-template>

    </article>
  </section>
</main>
