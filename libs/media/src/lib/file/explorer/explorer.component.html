<ng-container fxLayout *ngIf="root$ | async as root">
  <ng-container *ngIf="path$ | async as path">
    <aside>
      <mat-action-list [multiple]="false">
        <ng-container *ngFor="let dir of root.children | keyvalue">
          <button mat-list-item (click)="setPath(dir.key)" [ngClass]="{ active: path.startWith(dir.key) }">
            <mat-icon mat-list-icon [svgIcon]="dir.value.icon"></mat-icon>
            <span mat-line>{{ dir.value.name | maxLength: 20}}</span>
          </button>
        </ng-container>
      </mat-action-list>
    </aside>

    <section class="surface">

      <header fxLayout fxLayoutAlign="space-between center" *ngIf="crumbs$ | async as crumbs">
        <ng-container *ngIf="crumbs.length > 1">
          <button mat-icon-button (click)="setPath(crumbs[crumbs.length - 2])" matTooltip="Navigate back one step">
            <mat-icon svgIcon="arrow_back"></mat-icon>
          </button>
        </ng-container>

        <div fxLayout="row wrap" fxLayoutAlign="start center">
          <ng-container *ngFor="let crumb of crumbs; let isLast = last">
            <ng-container *ngIf="crumb | getDir:root as dir">
              <button mat-button [color]="isLast ? 'primary' : ''" (click)="setPath(crumb)">
                {{ dir.name }}
              </button>
              <span *ngIf="!isLast">></span>
            </ng-container>
          </ng-container>
        </div>
      </header>

      <mat-divider></mat-divider>

      <ng-container *ngIf="path | getDir:root as dir">
        <ng-container [ngSwitch]="dir.type">

          <ng-container *ngSwitchCase="'directory'">
            <mat-action-list>
              <ng-container *ngFor="let child of dir.children | keyvalue">
                <button mat-list-item (click)="setPath(child.key)">
                  <ng-container *ngIf="child.value as node">
                    <mat-icon [matBadge]="node.hasFile" matBadgeSize="small" *ngIf="node.type === 'directory' || node.multiple" mat-list-icon svgIcon="folder"></mat-icon>
                    <mat-icon [matBadge]="node.hasFile ? '✔' : ''" matBadgeSize="small" *ngIf="node.type === 'file' && !node.multiple" mat-list-icon svgIcon="document"></mat-icon>
                    <mat-icon [matBadge]="node.hasFile ? '✔' : ''" matBadgeSize="small" *ngIf="node.type === 'image' && !node.multiple" mat-list-icon svgIcon="image"></mat-icon>
                    <span mat-line>{{ node.name }}</span>
                  </ng-container>
                </button>
              </ng-container>
            </mat-action-list>
          </ng-container>

          <ng-container *ngSwitchCase="'list'">
            <file-explorer-list [dir]="dir"></file-explorer-list>
          </ng-container>

          <ng-container *ngSwitchCase="'file'">
            <file-explorer-file [dir]="dir"></file-explorer-file>
          </ng-container>
        </ng-container>

      </ng-container>
    </section>

  </ng-container>
</ng-container>
