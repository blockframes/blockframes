<mat-sidenav-container>
  <!-- Sidenav -->
  <mat-sidenav [opened]="true" mode="side">
    <material-category-repertory *ngIf="(materials$ | async) as materials" [template]="materials"></material-category-repertory>
    <article class="signature-button" fxLayout="row" fxLayoutAlign="center center">
      <button class="sign mat-elevation-z0" mat-raised-button routerLink="." fragment="sign">
        Add signature
        <mat-icon class="icon">create</mat-icon>
      </button>
    </article>
    <article class="container-button" fxLayout="row" fxLayoutAlign="center center">
      <button class="create-material mat-elevation-z0" mat-raised-button (click)="addForm('')">
        Add a material
        <mat-icon class="icon">add</mat-icon>
      </button>
    </article>
    <article class="container-button" fxLayout="row" fxLayoutAlign="center center">
      <button class="save-template mat-elevation-z0" mat-raised-button (click)="saveAsTemplate()">
        Save as new template
        <mat-icon class="icon">save</mat-icon>
      </button>
    </article>
    <article
      *ngIf="!(isDeliveryValidated$ | async)"
      class="container-button"
      fxLayout="row"
      fxLayoutAlign="center center">
      <button
        class="delete-delivery mat-elevation-z0"
        mat-raised-button
        (click)="openDeleteDelivery()">
        Delete delivery
        <mat-icon class="icon">delete</mat-icon>
      </button>
    </article>
    <article
      *ngIf="(isDeliveryValidated$ | async)"
      class="container-button"
      fxLayout="row"
      fxLayoutAlign="center center">
      <button
        class="unseal-delivery mat-elevation-z0"
        color="warn"
        mat-raised-button
        (click)="openUnsealDelivery()">
        Unseal delivery
        <mat-icon class="icon">lock_open</mat-icon>
      </button>
    </article>
  </mat-sidenav>
  <!-- Content -->
  <mat-sidenav-content class="delivery-form">
    <section>
      <article fxLayout="row" fxLayoutAlign="space-between center" class="title-block">
        <h2 *ngIf="(movie$ | async) as movie">{{ movie.title.original }}</h2>
        <span>
          <button
            [ngClass]="{ 'select-button-active': !!allChecked }"
            [disabled]="isDeliveryValidated$ | async"
            mat-raised-button
            (click)="selectAllMaterials()"
            class="select-button mat-elevation-z0">
            <span *ngIf="!allChecked">Select all materials</span>
            <span *ngIf="!!allChecked">Unselect materials</span>
          </button>
          <button
            class="action mat-elevation-z0"
            mat-raised-button
            [matMenuTriggerFor]="actions"
            [disabled]="isDeliveryValidated$ | async">
            Actions <mat-icon class="action-icon">expand_more</mat-icon>
          </button>
          <mat-menu #actions="matMenu" xPosition="before">
            <button mat-menu-item [matMenuTriggerFor]="steps">
              <span>Change step</span>
            </button>
            <mat-menu #steps="matMenu" xPosition="after">
              <ng-container *ngIf="(delivery$ | async).steps.length === 0; else hasSteps">
                <button mat-menu-item [disabled]="true">
                  <i>(no steps)</i>
                </button>
              </ng-container>
              <ng-template #hasSteps>
                <button
                  *ngFor="let step of (delivery$ | async).steps"
                  (click)="changeStep(step.id)"
                  mat-menu-item>
                  {{ step.name }}
                </button>
              </ng-template>
            </mat-menu>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="deleteSelectedMaterials()">
              <mat-icon color="warn">delete</mat-icon>
              <span>Delete</span>
            </button>
          </mat-menu>
        </span>
      </article>
      <article *ngIf="(form$ | async) as form">
        <material-delivery-add-form
          [isDeliveryValidated]="isDeliveryValidated$ | async"
          *ngIf="form.category === ''"
          (add)="addMaterial($event)">
        </material-delivery-add-form>
      </article>
      <article
        *ngFor="let category of (materials$ | async | keyvalue)"
        [id]="category.key"
        class="category-block">
        <div class="container" fxLayout="row" fxLayoutAlign="space-between center">
          <h3>{{ category.key }}</h3>
          <button
            class="category-material mat-elevation-z0"
            [disabled]="isDeliveryValidated$ | async"
            (click)="addForm(category.key)"
            mat-raised-button>
            Add a material
            <mat-icon class="icon">add</mat-icon>
          </button>
        </div>
        <div>
          <div *ngFor="let material of category.value">
            <ui-editable [item]="material" [itemId]="materialId">
              <ng-template materialViewMode>
                <material-delivery-item
                  [isDeliveryValidated]="isDeliveryValidated$ | async"
                  [material]="material"
                  [isChecked]="allChecked"
                  (isSelected)="selectMaterial($event, material.id)"
                  (isDeleted)="deleteMaterial(material)"
                  (update)="openUpdateForm(material)">
                </material-delivery-item>
              </ng-template>
              <ng-template materialEditMode>
                <material-delivery-form
                  [isDeliveryValidated]="isDeliveryValidated$ | async"
                  [material]="material"
                  (update)="updateMaterial($event)"
                  (cancelForm)="cancelUpdateForm()">
                </material-delivery-form>
              </ng-template>
            </ui-editable>
          </div>
          <div *ngIf="(form$ | async) as form">
            <material-delivery-add-form
              #addForm
              [isDeliveryValidated]="isDeliveryValidated$ | async"
              *ngIf="form.category === category.key"
              (add)="addMaterial($event)">
            </material-delivery-add-form>
          </div>
        </div>
      </article>
      <delivery-stakeholder-list id="sign"></delivery-stakeholder-list>
    </section>
  </mat-sidenav-content>
</mat-sidenav-container>
