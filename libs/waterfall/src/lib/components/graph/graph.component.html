
<section class="surface" [ngStyle]="{ width: showEditPanel ? '50%' : '100%' }" (dblclick)="select('')">
  <header *ngIf="!readonly">
    <div>
      <h2>
        <span>Waterfall Scheme</span>
        <mat-icon 
          *ngIf="isDefaultVersion && waterfall.versions.length > 1"
          color="warn"
          svgIcon="warning"
          matTooltip="You are editing the default version of this waterfall. Except already overwritten receipt share percentage and conditions, changes performed on this version will be applied to all not standalone versions."
        ></mat-icon>
      </h2>
      <button mat-icon-button [matTooltip]="(showEditPanel ? 'Hide' : 'Show') + ' Edit Panel'" (click)="toggleEditPanel()">
        <mat-icon [svgIcon]="showEditPanel ? 'chevron_right' : 'chevron_left'"></mat-icon>
      </button>
    </div>
    <p>Please provide the condition details to establish the accurate waterfall</p>
  </header>

  <bf-graph-container>

    <waterfall-graph-node
      *ngFor="let node of (nodes$ | async)"
      [node]="node"
      [canUpdate]="canUpdateGraph"
      (addChild)="addChild($event)"
      (handleSelect)="select($event)"
      (addSibling)="addSibling($event)"
      [selected]="(selected$ | async)"
      [ngStyle]="{ left: node.x + 'px', top: node.y + 'px' }"
    ></waterfall-graph-node>

    <svg:path *ngFor="let arrow of (arrows$ | async)" edge [attr.d]="arrow.path" stroke-width="2" stroke="#9392A7" fill="none"></svg:path>
    <waterfall-graph-label *ngFor="let arrow of (arrows$ | async)" node [ngStyle]="{ left: arrow.labelPosition.x + 'px', top: arrow.labelPosition.y + 'px' }" [arrow]="arrow"></waterfall-graph-label>

  </bf-graph-container>
</section>

<bf-card-modal [ngStyle]="{ display: showEditPanel ? 'block' : 'none' }">
  <ng-container *ngIf="selected$ | async as selected; else noSelection">
    <ng-container *ngIf="isSourceSelected; else notSource">
      <header>
        <h2>Receipt Source</h2>
        <button mat-icon-button (click)="cardModal.toggle()" [matTooltip]="cardModal.isOpened ? 'Shrink' : 'Enlarge'">
          <mat-icon [svgIcon]="cardModal.isOpened ? 'fullscreen_exit' : 'fullscreen'"></mat-icon>
        </button>
        <button mat-icon-button matTooltip="Save changes" (click)="updateSource()" [disabled]="!canUpdateGraph">
          <mat-icon svgIcon="save"></mat-icon>
        </button>
        <button mat-icon-button matTooltip="Delete Source" (click)="delete()" [disabled]="!canUpdateGraph">
          <mat-icon svgIcon="delete"></mat-icon>
        </button>
      </header>
      <section [ngClass]="[cardModal.isOpened ? 'modal' : 'card']">
        <group-multiselect
          scope="medias"
          label="Choose Media"
          displayAll="All Medias"
          filterPlaceholder="Specify territories to filter"
          [control]="sourceForm.get('medias')"
        ></group-multiselect>
        <group-multiselect
          scope="territories"
          label="Choose Territories"
          displayAll="World"
          filterPlaceholder="Specify territories to filter"
          [control]="sourceForm.get('territories')"
        ></group-multiselect>
        <mat-form-field appearance="outline">
          <mat-label>Name</mat-label>
          <input matInput type="text" placeholder="Receipt Share Name" [formControl]="sourceForm.get('name')" />
        </mat-form-field>
      </section>
    </ng-container>
    <ng-template #notSource>
      <header>
        <h2>Receipt Share</h2>
        <button mat-icon-button (click)="cardModal.toggle()" [matTooltip]="cardModal.isOpened ? 'Shrink' : 'Enlarge'">
          <mat-icon [svgIcon]="cardModal.isOpened ? 'fullscreen_exit' : 'fullscreen'"></mat-icon>
        </button>
        <button mat-icon-button matTooltip="Save changes" (click)="updateRight()">
          <mat-icon svgIcon="save"></mat-icon>
        </button>
        <button mat-icon-button matTooltip="Delete Right" (click)="delete()" [disabled]="!canUpdateGraph">
          <mat-icon svgIcon="delete"></mat-icon>
        </button>
      </header>
      <mat-tab-group>
        <mat-tab label="Receipts Shares">
          <section [ngClass]="[cardModal.isOpened ? 'modal' : 'card']">
            <p>Fill the following fields to define the Receipt Share.</p>
    
            <static-select [control]="rightForm.get('type')" scope="rightTypes" [withoutValues]="['horizontal','vertical']">
              <mat-label>Type</mat-label>
            </static-select>
    
            <bf-autocomplete
              required
              label="Right Holder Name"
              error="To select a Right Holder, first add a contract with them."
              [options]="rightholderNames$"
              placeholder="Choose Right Holder"
              [form]="rightholderControl"
            ></bf-autocomplete>

            <mat-form-field *ngIf="(relevantContracts$ | async).length" appearance="outline">
              <mat-label>Contract</mat-label>
              <mat-select [formControl]="rightForm.get('contract')">
                <mat-option *ngFor="let contract of (relevantContracts$ | async)" [value]="contract.id">{{contract.name}}</mat-option>
              </mat-select>
            </mat-form-field>
    
            <mat-form-field appearance="outline">
              <mat-label>Name</mat-label>
              <input matInput type="text" placeholder="Receipt Share Name" [formControl]="rightForm.get('name')" />
            </mat-form-field>
    
            <mat-form-field appearance="outline">
              <mat-label>Percentage</mat-label>
              <mat-icon svgIcon="percent" matPrefix></mat-icon>
              <input matInput type="number" min="0" max="100" [formControl]="rightForm.get('percent')" />
            </mat-form-field>
    
            <p>Parent Revenue Element(s)</p>
            <mat-form-field appearance="outline">
              <mat-label>Parent Name(s)</mat-label>
              <mat-select multiple [formControl]="rightForm.get('parents')">
                <mat-option *ngFor="let node of (nodes$ | async)" [value]="node.id">{{node.name}}</mat-option>
              </mat-select>
              <mat-hint>Choose parent revenue elements from which this Receipt Share draw funds. You can add as many parents as you want.</mat-hint>
            </mat-form-field>
    
            <div class="info">
              <mat-icon svgIcon="info"></mat-icon>
              <p>If you have multiple steps, you can set them up later inside conditions.</p>
            </div>
    
            <div class="add-next">
              <hr/>
              <p class="mat-caption">Add Next Receipt Share</p>
              <button mat-mini-fab color="primary" (click)="addChild(selected)"[disabled]="!canUpdateGraph" >
                <mat-icon svgIcon="add"></mat-icon>
              </button>
            </div>
          </section>
        </mat-tab>
        <mat-tab label="Conditions">
          <section [ngClass]="[cardModal.isOpened ? 'modal' : 'card']">
            <waterfall-conditions [canUpdate]="canUpdateConditions" [rightForm]="rightForm" [rightId]="selected" (createStep)="createNewStep()" (deleteStep)="deleteStep($event)"></waterfall-conditions>
          </section>
        </mat-tab>
      </mat-tab-group>
    </ng-template>
  </ng-container>
  <ng-template #noSelection>
    <ng-container *ngIf="(nodes$ | async).length; else emptyGraph">
      <header>
        <h2>Receipt Share List</h2>
        <button mat-icon-button (click)="cardModal.toggle()" [matTooltip]="cardModal.isOpened ? 'Shrink' : 'Enlarge'">
          <mat-icon [svgIcon]="cardModal.isOpened ? 'fullscreen_exit' : 'fullscreen'"></mat-icon>
        </button>
      </header>
      <p class="description"><strong>Pool</strong> is needed when several Receipts Shares come from different sources, but should be used in the same condition.</p>
      <mat-tab-group>
        <mat-tab label="Receipts Shares">
          <section [ngClass]="[cardModal.isOpened ? 'modal' : 'card']">
            <waterfall-right-list (deleteRight)="delete($event)" (selectRight)="select($event)" [canUpdate]="canUpdateGraph"></waterfall-right-list>
          </section>
        </mat-tab>
        <mat-tab label="Pools Only">
          <section [ngClass]="[cardModal.isOpened ? 'modal' : 'card']">
            <waterfall-pool-list [canUpdate]="canUpdateGraph"></waterfall-pool-list>
          </section>
        </mat-tab>
      </mat-tab-group>
      <section class="add">
        <button mat-flat-button color="primary" (click)="createNewSource()" [disabled]="!canUpdateGraph" >
          <mat-icon svgIcon="add"></mat-icon>
          <span>New Receipt Source</span>
        </button>
        <button mat-flat-button color="primary" (click)="createNewRight()" [disabled]="!canUpdateGraph" >
          <mat-icon svgIcon="add"></mat-icon>
          <span>New Receipt Share</span>
        </button>
      </section>
    </ng-container>
    <ng-template #emptyGraph>
      <header>
        <h2>Instructions</h2>
      </header>
      <section class="begin">
        <h3>Title Waterfall Creation Guide</h3>
        <p class="mat-body-1">Welcome to the section dedicated to crafting the revenue distribution (waterfall) for your film or series (Title). Please adhere to the following structured guidelines to ensure an accurate and efficient setup:</p>

        <h3>Understanding the Waterfall Schema:</h3>
        <p class="mat-body-1">This schema illustrates the revenue flow, systematically channeling funds from the top tier downwards.</p>

        <h3>Identifying Receipt Sources:</h3>
        <p class="mat-body-1">These are the origins of your revenue. Typically, they encompass various media and geographical territories.</p>

        <h3>Allocating Receipt Shares:</h3>
        <p class="mat-body-1">Receipt Shares represent the entitlements granted to each stakeholder, allowing them to claim a portion of the earnings. This may include commission fees, recoupment of expenses, the producer’s net revenue share, or other rights afforded to stakeholders.</p>

        <h3>Step-by-Step Waterfall Creation:</h3>
        <ol>
          <li>Individual Stakeholder Focus: Tackle the waterfall creation one stakeholder at a time. It’s advisable to start with the sales agent and main distributor’s mandates.</li>
          <li>Establish Receipt Sources: For each stakeholder, identify and list all the Receipt Sources from which they derive revenue.</li>
          <li>Structure Receipt Shares: Begin by allocating Receipt Shares that draw from the initial earnings ('first euros'). Subsequently, establish subsequent shares in a sequential manner.</li>
        </ol>
        <button mat-button (click)="openIntercom()">
          <mat-icon svgIcon="help"></mat-icon>
          <span>Ask for Help</span>
        </button>
        <section class="add">
          <button mat-flat-button color="primary" (click)="createNewSource()" [disabled]="!canUpdateGraph" >
            <mat-icon svgIcon="add"></mat-icon>
            <span>New Receipt Source</span>
          </button>
          <button mat-flat-button color="primary" (click)="createNewRight()" [disabled]="!canUpdateGraph" >
            <mat-icon svgIcon="add"></mat-icon>
            <span>New Receipt Share</span>
          </button>
        </section>
      </section>
    </ng-template>
  </ng-template>
</bf-card-modal>
