
<h1 *ngIf="createMode" i18n>Create Waterfall for {{ shell.movie.title.international }}</h1>
<h1 *ngIf="!createMode" i18n>Edit Waterfall for {{ shell.movie.title.international }}</h1>

<mat-stepper #stepper (click)="onStepClicked($event)" linear>
  <!-- override default stepper icons for the "edit" & "done" steps -->
  <ng-template matStepperIcon="edit" let-index="index">
    {{index + 1}}
  </ng-template>
  <ng-template matStepperIcon="done" let-index="index">
    {{index + 1}}
  </ng-template>

  <mat-step [completed]="contractForm.pristine">
    <ng-template matStepLabel i18n>Add Contracts</ng-template>
    <ng-template matStepContent>
      <div class="surface">
        <waterfall-contract-list [contractForm]="contractForm" (redirectToBuilder)="redirectToBuilder()"></waterfall-contract-list>
      </div>
      <article>
        <ng-container *ngIf="updating$ | async; else editContracts">
          <logo-spinner></logo-spinner>
        </ng-container>
        <ng-template #editContracts>
          <p *ngIf="invalidDocument$ | async" class="mat-error" i18n>Add at least 1 contract to continue</p>
          <button mat-flat-button color="primary" [disabled]="invalidDocument$ | async" (click)="next()">
            <span i18n>Continue</span>
            <mat-icon iconPositionEnd svgIcon="arrow_forward"></mat-icon>
          </button>
          <button mat-button class="save" (click)="exit()">
            <mat-icon svgIcon="save"></mat-icon>
            <span i18n>Save & Come back later</span>
          </button>
        </ng-template>
      </article>
    </ng-template>
  </mat-step>

  <mat-step completed>
    <ng-template matStepLabel i18n>Add Right Holders</ng-template>
    <waterfall-rightholder-form [rightholdersForm]="rightholdersForm" [waterfall]="shell.waterfall"></waterfall-rightholder-form>
    <article>
      <ng-container *ngIf="updating$ | async; else editRightHolders">
        <logo-spinner></logo-spinner>
      </ng-container>
      <ng-template #editRightHolders>
        <p *ngIf="noProducer$ | async" class="mat-error" i18n>There might be only one {{ 'producer' | toLabel: 'rightholderRoles' }} per film</p>
        <section>
          <button mat-button color="primary" (click)="previous()">
            <mat-icon svgIcon="arrow_back"></mat-icon>
            <span i18n>Back</span>
          </button>
          <button mat-flat-button color="primary" (click)="next()" [disabled]="rightholdersForm.invalid || (noProducer$ | async)">
            <span i18n>Continue</span>
            <mat-icon iconPositionEnd svgIcon="arrow_forward"></mat-icon>
          </button>
        </section>
        <button mat-button class="save" (click)="exit()" [disabled]="rightholdersForm.invalid">
          <mat-icon svgIcon="save"></mat-icon>
          <span i18n>Save & Come back later</span>
        </button>
      </ng-template>
    </article>
  </mat-step>

  <mat-step>
    <ng-template matStepLabel i18n>Build Waterfall</ng-template>
    <ng-container *ngIf="(manualCreation$ | async) || (shell.sources$ | async)?.length > 0 || (shell.rights$ | async)?.length > 0; else noWaterfall">
      <waterfall-version-selector [ngClass]="(shell.versionId$ | async) ? '' : 'hide'"></waterfall-version-selector>
      <div class="surface toolbar">
        <span>
          <button color="primary" mat-button (click)="triggerNewSource$.next(!triggerNewSource$.value)" [disabled]="isDuplicateVersion">
            <mat-icon svgIcon="add"></mat-icon>
            <span i18n>Source</span>
          </button>
          <button color="primary" mat-button (click)="triggerNewRight$.next(!triggerNewRight$.value)" [disabled]="isDuplicateVersion">
            <mat-icon svgIcon="add"></mat-icon>
            <span i18n>Receipt Share</span>
          </button>
          <button color="primary" mat-button (click)="triggerUnselect$.next(!triggerUnselect$.value)">
            <mat-icon svgIcon="view_list"></mat-icon>
            <span i18n>Receipt Share List</span>
          </button>
          <button 
            color="primary"
            mat-button
            (click)="simulate()"
            [disabled]="(shell.canInitWaterfall$ | async) === false"
            [matTooltip]="(shell.canInitWaterfall$ | async) === false  ? missingSimulationData : ''"
          >
            <mat-icon svgIcon="default_currency"></mat-icon>
            <span *ngIf="shell.stateMode$.value === 'builder'" i18n>Start Revenue Simulation</span>
            <span *ngIf="shell.stateMode$.value === 'simulation'" i18n>Exit Simulation</span>
          </button>
        </span>

        <a mat-button href="https://www.blockframes.io/doc/welcome-page" target="_blank">
          <mat-icon svgIcon="help"></mat-icon>
          <span i18n>Need Help?</span>
        </a>
      </div>
      <waterfall-graph 
        (canLeaveGraphForm)="canLeaveGraphForm = $event"
        [simulationForm]="simulationForm"
        [triggerNewSource]="triggerNewSource$ | async"
        [triggerNewRight]="triggerNewRight$ | async"
        [triggerUnselect]="triggerUnselect$ | async"
      ></waterfall-graph>
    </ng-container>
    <ng-template #noWaterfall>
      <article class="surface">
        <h1 i18n>Build your Waterfall</h1>
        <p i18n>Please choose if you want to create a waterfall yourself or import one, or else our team can do it for you.</p>
        <p i18n>Do you need help? <a>Contact our team.</a></p>
        <section>
          <a class="surface" (click)="displayGraph()">
            <img asset="add_draft.svg" alt="Create waterfall image">
            <button mat-button color="primary" i18n>Create Waterfall yourself</button>
          </a>
          <a class="surface" (click)="openIntercom()">
            <img asset="feature_key3.svg" alt="Ask out team image">
            <button mat-button color="primary" i18n>Ask Blockframes Team to do it!</button>
          </a>
        </section>
      </article>
    </ng-template>
    <article>
      <ng-container *ngIf="updating$ | async; else editWaterfall">
        <logo-spinner></logo-spinner>
      </ng-container>
      <ng-template #editWaterfall>
        <section>
          <button mat-button color="primary" (click)="previous()">
            <mat-icon svgIcon="arrow_back"></mat-icon>
            <span i18n>Back</span>
          </button>
          <button 
            mat-flat-button 
            color="primary"
            [disabled]="(shell.canInitWaterfall$ | async) === false"
            [matTooltip]="(shell.canInitWaterfall$ | async) === false  ? missingData : ''"
            (click)="publishWaterfall()">
            <span *ngIf="createMode" i18n>Publish Waterfall</span>
            <span *ngIf="!createMode" i18n>Update Waterfall</span>
            <mat-icon iconPositionEnd svgIcon="arrow_forward"></mat-icon>
          </button>
        </section>
        <button mat-button class="save" (click)="exit()">
          <mat-icon svgIcon="save"></mat-icon>
          <span i18n>Save & Come back later</span>
        </button>
      </ng-template>
    </article>
  </mat-step>

</mat-stepper>
